<!doctype html>
<html lang="zh-Hant" class="dark">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/x-icon" href="/static/app_icon.ico">
  <title>Current Probe (TE) - 2.0</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/static/css/style.css">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            slate: { 850: '#151e2e' }
          }
        }
      }
    }
  </script>
</head>

<body class="bg-slate-950 text-slate-200 h-screen flex flex-col overflow-hidden font-sans">

  <!-- Header -->
  <header class="h-12 border-b border-slate-800 bg-slate-900 flex items-center justify-between px-4 shrink-0 z-50">
    <div class="flex items-center gap-3">
      <!-- Sidebar Toggle Removed from Header -->

      <div class="w-3 h-3 rounded-full bg-emerald-500 shadow shadow-emerald-500/50"></div>
      <h1 class="font-bold text-slate-100 tracking-wide">Current Probe <span
          class="text-emerald-400 font-mono text-xs ml-1">v2.1</span></h1>
    </div>
    <div class="text-xs text-slate-500 font-mono">2026/01/02 Logic Refined</div>
  </header>

  <!-- Main Workspace -->
  <div class="flex-1 flex overflow-hidden">

    <!-- Left Sidebar: Controls -->
    <aside id="sidebar"
      class="w-80 bg-slate-900 border-r border-slate-800 flex flex-col overflow-y-auto shrink-0 z-40 shadow-xl transition-all duration-300 ease-in-out">
      <!-- File Input -->
      <div class="p-4 border-b border-slate-800 relative">
        <div class="flex justify-between items-center mb-2">
          <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider">Source Image</label>
          <!-- Close Button (Inside Sidebar) -->
          <button id="btnCloseSidebar" class="p-1 hover:bg-slate-800 rounded text-slate-400 hover:text-white">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <input type="file" id="imgFile" accept="image/*"
          class="block w-full text-xs text-slate-400 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-emerald-900 file:text-emerald-300 hover:file:bg-emerald-800" />
      </div>

      <!-- Accordion items would be nice, but flat list is fine for now -->
      <div class="p-4 space-y-6">
        <!-- Reference Lines -->
        <div class="space-y-3">
          <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
            <span class="w-1 h-3 bg-sky-500 rounded-full"></span> Reference Lines
          </h3>
          <div class="grid grid-cols-[auto_1fr] gap-x-2 gap-y-3 items-center text-sm">
            <label class="text-yellow-400 font-mono">Yellow</label>
            <div class="flex items-center gap-2">
              <input type="range" id="refIdxY" min="0" max="8" value="7"
                class="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-yellow-500" />
            </div>

            <label class="text-fuchsia-400 font-mono">Magenta</label>
            <div class="flex items-center gap-2">
              <input type="range" id="refIdxM" min="0" max="8" value="7"
                class="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-fuchsia-500" />
            </div>

            <label class="text-emerald-400 font-mono">Green</label>
            <div class="flex items-center gap-2">
              <input type="range" id="refIdx" min="0" max="8" value="7"
                class="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-emerald-500" />
            </div>
          </div>
        </div>

        <!-- Labels -->
        <div class="space-y-3">
          <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
            <span class="w-1 h-3 bg-fuchsia-500 rounded-full"></span> Labels & Units
          </h3>
          <div class="grid grid-cols-3 gap-2">
            <input type="text" id="labelCLK" value="CLK"
              class="bg-slate-800 border border-slate-700 rounded px-2 py-1 text-xs text-yellow-300 focus:outline-none focus:border-yellow-500" />
            <input type="text" id="labelVDD" value="VDD"
              class="bg-slate-800 border border-slate-700 rounded px-2 py-1 text-xs text-fuchsia-300 focus:outline-none focus:border-fuchsia-500" />
            <input type="text" id="labelIVDD" value="I(VDD)"
              class="bg-slate-800 border border-slate-700 rounded px-2 py-1 text-xs text-emerald-300 focus:outline-none focus:border-emerald-500" />
          </div>
          <div>
            <label class="text-xs text-slate-500 mb-1 block">mA / Division</label>
            <input type="number" id="maDiv" step="0.1" value="5.0"
              class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1 text-xs focus:outline-none focus:border-sky-500" />
          </div>
        </div>

        <!-- Grid Coords -->
        <div class="space-y-3">
          <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
            <span class="w-1 h-3 bg-slate-500 rounded-full"></span> Manual Grid
          </h3>
          <div class="grid grid-cols-2 gap-2 text-xs">
            <div>
              <label class="text-slate-500">Top</label>
              <input type="number" id="inTop" class="w-full bg-slate-800 border-slate-700 rounded px-1" />
            </div>
            <div>
              <label class="text-slate-500">Bottom</label>
              <input type="number" id="inBottom" class="w-full bg-slate-800 border-slate-700 rounded px-1" />
            </div>
            <div>
              <label class="text-slate-500">Left</label>
              <input type="number" id="inLeft" class="w-full bg-slate-800 border-slate-700 rounded px-1" />
            </div>
            <div>
              <label class="text-slate-500">Right</label>
              <input type="number" id="inRight" class="w-full bg-slate-800 border-slate-700 rounded px-1" />
            </div>
          </div>
        </div>
      </div>

      <!-- Action -->
      <div class="mt-auto p-4 border-t border-slate-800">
        <button id="btnSaveCfg"
          class="w-full py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs rounded border border-slate-700 transition-colors">
          Save Configuration
        </button>
      </div>
      <!-- Instructions -->
      <div class="p-4 border-t border-slate-800">
        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">使用說明</h3>
        <ul class="text-[10px] text-slate-500 list-decimal list-inside space-y-1 font-mono leading-relaxed">
          <li>載入圖片後，拖曳格線或把手進行對齊。</li>
          <li>批次處理會套用目前的格線設定到所有檔案。</li>
          <li>檔名包含 <code>_IR?mA</code> 會優先使用該數值，否則使用設定值。</li>
          <li>新功能：自動偵測 CLK 抬升段並進行三點測量。</li>
          <li>測量點：起始 (峰值)、中間 (40%)、結束 (最後一格中心)。</li>
          <li>輸出檔名將包含測量數值 (小數點後兩位)。</li>
          <li>點擊「儲存設定」以保留參數。</li>
        </ul>
      </div>
    </aside>

    <!-- Right: Workspace + Gallery -->
    <main class="flex-1 flex flex-col min-w-0 bg-slate-950 relative">

      <!-- Floating Open Button (Visible when sidebar closed) -->
      <button id="btnOpenSidebar"
        class="absolute top-4 left-4 z-30 p-2 bg-slate-900 border border-slate-700 rounded shadow-xl text-slate-400 hover:text-white hidden">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>

      <!-- Canvas Area (Fixed height or grow?) -> Let's make it flexible but constrained -->
      <div id="canvas-area"
        class="flex-1 overflow-hidden relative canvas-container flex items-center justify-center p-4 transition-all duration-300">
        <canvas id="canvas"
          class="shadow-2xl border border-slate-700 rounded bg-black max-w-full max-h-full object-contain"></canvas>
      </div>

      <!-- Bottom: Batch Process & Gallery (Reduced height) -->
      <section id="gallery-area"
        class="h-40 min-h-0 border-t border-slate-800 bg-slate-900 flex flex-col shrink-0 overflow-hidden transition-all duration-300">
        <!-- Toolbar -->
        <div class="h-10 border-b border-slate-800 flex items-center justify-between px-4 bg-slate-850">
          <div class="flex items-center gap-4">
            <h2 class="font-bold text-sm text-slate-300">Result Gallery</h2>
            <!-- Hidden Input -->
            <input type="file" id="batchFiles" accept="image/*" multiple class="hidden" />

            <button id="btnBatch"
              class="px-4 py-1.5 bg-sky-600 hover:bg-sky-500 text-white text-xs font-bold rounded shadow-lg shadow-sky-900/50 transition-all flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z">
                </path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              Start Processing
            </button>
          </div>

          <div class="flex items-center gap-3">
            <span id="progressText" class="text-xs text-slate-400 font-mono hidden">Processing...</span>
            <div id="progressWrap" class="w-32 h-2 bg-slate-800 rounded-full hidden">
              <div id="progressBar" class="h-full bg-emerald-500 rounded-full w-0 transition-all duration-300"></div>
            </div>

            <!-- Download Button (Hidden until results exist) -->
            <button id="btnDownload"
              class="hidden px-4 py-1.5 bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold rounded shadow-lg shadow-emerald-900/50 transition-all flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
              </svg>
              Download ZIP
            </button>
          </div>
        </div>

        <!-- Grid -->
        <div class="flex-1 overflow-y-auto p-4 content-start">
          <!-- Gallery Grid -->
          <div id="gallery-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
            <!-- Cards will be injected here -->
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- Toast Container -->
  <div id="toast-container"
    class="fixed top-16 right-4 z-[100] flex flex-col items-end pointer-events-none child:pointer-events-auto"></div>

  <!-- Lightbox Modal -->
  <div id="lightbox"
    class="fixed inset-0 z-[200] bg-black/90 hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-200">
    <button id="lightbox-close" class="absolute top-4 right-4 text-slate-400 hover:text-white p-2">
      <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>
    <img id="lightbox-img" class="max-w-full max-h-full object-contain rounded shadow-2xl" src="" alt="Result" />
  </div>

  <script src="/static/js/ui.js"></script>
  <script src="/static/js/app.js"></script>
  <script>
    // Sidebar Logic
    const sidebar = document.getElementById('sidebar');
    const btnOpen = document.getElementById('btnOpenSidebar');
    const btnClose = document.getElementById('btnCloseSidebar');

    function toggleSidebar(show) {
      if (show) {
        sidebar.classList.remove('w-0', 'border-0', 'p-0', 'overflow-hidden');
        sidebar.classList.add('w-80', 'border-r');
        btnOpen.classList.add('hidden');
      } else {
        sidebar.classList.remove('w-80', 'border-r');
        sidebar.classList.add('w-0', 'border-0', 'p-0', 'overflow-hidden');
        btnOpen.classList.remove('hidden');
      }
    }

    btnOpen.addEventListener('click', () => toggleSidebar(true));
    btnClose.addEventListener('click', () => toggleSidebar(false));


    document.getElementById('btnBatch').addEventListener('click', () => {
      document.getElementById('batchFiles').click();
    });

    document.getElementById('batchFiles').addEventListener('change', async (e) => {
      const files = Array.from(e.target.files || []);
      if (!files.length) return;

      // Clear previous results & toasts
      window.clearGallery();
      window.clearToasts();
      document.getElementById('btnDownload').classList.add('hidden');

      // Toggle Layout: Hide Canvas, Expand Gallery
      const canvasArea = document.getElementById('canvas-area');
      const galleryArea = document.getElementById('gallery-area');

      // Add classes for hidden canvas / full height gallery
      canvasArea.classList.add('h-0', 'p-0', 'opacity-0');
      canvasArea.classList.remove('flex-1', 'p-4');

      galleryArea.classList.remove('h-40', 'shrink-0');
      galleryArea.classList.add('flex-1');

      // Show Progress
      const pText = document.getElementById('progressText');
      const pWrap = document.getElementById('progressWrap');
      const pBar = document.getElementById('progressBar');
      pText.classList.remove('hidden'); pText.textContent = "Uploading...";
      pWrap.classList.remove('hidden'); pBar.style.width = '0%';

      let successCount = 0;
      let failCount = 0;

      try {
        // 1. Upload Files
        const form = new FormData();
        for (const f of files) form.append('files', f);

        pText.textContent = "Processing...";

        const response = await fetch('/api/process_stream', {
          method: 'POST',
          body: form
        });

        if (!response.ok) {
          throw new Error(`Server Error ${response.status}: ${response.statusText}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        let processedCount = 0;
        const total = files.length;

        // Read Loop
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n\n'); // SSE standard separator
          buffer = lines.pop(); // Keep partial line

          for (const line of lines) {
            const trim = line.trim();
            if (!trim.startsWith('data: ')) continue;

            const jsonStr = trim.substring(6); // remove 'data: '
            if (jsonStr === '[DONE]') {
              break;
            }

            try {
              const data = JSON.parse(jsonStr);
              // data: { id, filename, status, values: [...], img_url }

              // Update UI
              window.renderResultCard(data);

              // Convert filename to Short ID for display
              let displayId = data.filename;
              try {
                const parts = data.filename.split('_');
                if (parts.length >= 8) displayId = parts[7];
              } catch (e) { }

              // Update Grouped Toast
              if (data.status === '成功') {
                successCount++;
                window.updateStatusToast('success', successCount, displayId);
              } else {
                failCount++;
                window.updateStatusToast('error', failCount, displayId);
              }

              processedCount++;
              const pct = Math.round((processedCount / total) * 100);
              pBar.style.width = `${pct}%`;
              pText.textContent = `Processing (${processedCount}/${total})`;

            } catch (err) {
              console.error("SSE Parse Error", err);
            }
          }
        }

        // Done
        pText.textContent = "Completed";
        document.getElementById('btnDownload').classList.remove('hidden');

      } catch (e) {
        console.error(e);
        window.showToast('Error: ' + e.message, 'error');
        // Restore progress bar
        pText.textContent = "Error";
        pBar.classList.add('bg-red-500');
      } finally {
        // Optional: Restore layout? 
        // User said: "Start Processing的时候... 預覽就可以收起來了"
        // They didn't explicitly say "restore it after".
        // Keeping it expanded allows viewing results. 
        // We can add a "Reset Layout" button or just leave it until new image load.
        // But if user picks a new single image, we should probably restore.
        // For now, leave as is. User can reload or we can add logic to single image load.
      }
    });

    document.getElementById('btnDownload').addEventListener('click', () => {
      window.location.href = '/api/results/zip';
    });

    // Initialize App
    window.dispatchEvent(new Event('load'));
  </script>
</body>

</html>